jar{
    manifest{
        attributes 'Main-Class': 'bupt.sse.hadoop.cfrs.usercf.Main'
    }
}

ext{
    OUTPUT_JAR = "build/libs/${project.name}-all.jar"
    HDFS_OUTPUT_DIR = "${PROJECT_HDFS_OUTPUT_DIR}/UserCF"
}

task buildAndRun(dependsOn: 'shadowJar'){
    doLast{
        try {
            exec{
                commandLine "${HADOOP_HOME}/bin/hdfs", 'dfs', '-rm', '-r', HDFS_OUTPUT_DIR
            }
        }catch (Exception ignore){}

        exec{
            commandLine "${HADOOP_HOME}/bin/hdfs", 'dfs', '-mkdir', '-p', HDFS_OUTPUT_DIR
        }

        exec{
            commandLine "${HADOOP_HOME}/bin/hadoop", 'jar', OUTPUT_JAR, "${PROJECT_HDFS_INPUT_DIR}/ratings.csv", "${HDFS_OUTPUT_DIR}/Step1", "${HDFS_OUTPUT_DIR}/Step2", "${HDFS_OUTPUT_DIR}/Step3", "${HDFS_OUTPUT_DIR}/Step4", "${HDFS_OUTPUT_DIR}/Step5"
        }
    }
}